
<!doctype html>
<html class="theme-next use-motion theme-next-mala">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="醉卧塌上看风轻云淡，漫卷诗书听雨打芭蕉" />



  <meta name="keywords" content="Web,工程化,Webpack," />



  <link rel="alternate" href="/atom.xml" title="Robin's blog" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="前言  前端的发展，离不开打包工具的助推。关于打包工具种类繁多，其中 Webpack 作为佼佼者被广泛使用。通过配置选项和 Loader、Plugin，我们可以实现各种功能。那么 Webpack 内部到底是怎么运行，通过本系列的源码学习，希望能给笔者有一个完整的认识。">
<meta name="keywords" content="Web,工程化,Webpack">
<meta property="og:type" content="article">
<meta property="og:title" content="再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起">
<meta property="og:url" content="http://whtacm.cc/2021/10/18/再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起/index.html">
<meta property="og:site_name" content="Robin&#39;s blog">
<meta property="og:description" content="前言  前端的发展，离不开打包工具的助推。关于打包工具种类繁多，其中 Webpack 作为佼佼者被广泛使用。通过配置选项和 Loader、Plugin，我们可以实现各种功能。那么 Webpack 内部到底是怎么运行，通过本系列的源码学习，希望能给笔者有一个完整的认识。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2021-11-02T13:16:22.568Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起">
<meta name="twitter:description" content="前言  前端的发展，离不开打包工具的助推。关于打包工具种类繁多，其中 Webpack 作为佼佼者被广泛使用。通过配置选项和 Loader、Plugin，我们可以实现各种功能。那么 Webpack 内部到底是怎么运行，通过本系列的源码学习，希望能给笔者有一个完整的认识。">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mala',
    sidebar: '[object Object]'
  };
</script>

  <title> 再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起 | Robin's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  

  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?97551011862ccb1d84eef0bd7737cfc3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">人淡如菊</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    
      

      

    

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2021-10-18T11:02:01+08:00" content="2021-10-18">
            2021-10-18
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/工程化/" itemprop="url" rel="index">
                  <span itemprop="name">工程化</span>
                </a>
              </span>

              
              
                ， 
              

            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/工程化/Webpack/" itemprop="url" rel="index">
                  <span itemprop="name">Webpack</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <!--
              <a href="/2021/10/18/再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2021/10/18/再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起/" itemprop="commentsCount"></span>
              </a>
              -->
              <a href="/2021/10/18/再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起/#comments" itemprop="discussionUrl">
                <span>评论</span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><blockquote>
<p>前言</p>
</blockquote>
<p>前端的发展，离不开打包工具的助推。关于打包工具种类繁多，其中 Webpack 作为佼佼者被广泛使用。通过配置选项和 Loader、Plugin，我们可以实现各种功能。那么 Webpack 内部到底是怎么运行，通过本系列的源码学习，希望能给笔者有一个完整的认识。</p>
<a id="more"></a>
<p><br></p>
<h1 id="1、准备工作"><a href="#1、准备工作" class="headerlink" title="1、准备工作"></a>1、准备工作</h1><h2 id="1-1、工具及版本说明"><a href="#1-1、工具及版本说明" class="headerlink" title="1.1、工具及版本说明"></a>1.1、工具及版本说明</h2><p>首先，在阅读本文之前。我们先约定下本系列文章约定的源码版本，如下：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">webpack</span> 4<span class="selector-class">.46</span><span class="selector-class">.0</span></div></pre></td></tr></table></figure></p>
<p>对于 Node 版本，笔者使用的 14 的大版本，当然为了方便调试，建议使用不低于 10 的大版本。另外，我们使用 <em>VSCode</em> 进行调试和代码阅读。</p>
<h2 id="1-2、约定及说明"><a href="#1-2、约定及说明" class="headerlink" title="1.2、约定及说明"></a>1.2、约定及说明</h2><p>阅读源码是一个学习的过程，当然也是一个比较痛苦的过程，尤其是 webpack 这种使用 hooks 来完成主流程的库。在主要步骤中会很跳跃，这一定程度上增加了源码阅读的难度，本文会集中在几个关键阶段或部分：compiler 、compilation 、Tapable 和 Hook、Module及其处理器 Loader、Plugin。并对行数过长的方法进行代码删减，保留一些关键代码的方法来让读者对整体执行流程有一个简单认识。然后，再根据自己的需要，按图索骥的对感兴趣的部分进行深入阅读。</p>
<h1 id="2、源码分析"><a href="#2、源码分析" class="headerlink" title="2、源码分析"></a>2、源码分析</h1><h2 id="2-1、Webpack-执行入口"><a href="#2-1、Webpack-执行入口" class="headerlink" title="2.1、Webpack 执行入口"></a>2.1、Webpack 执行入口</h2><p>首先我们找到程序的入口位置，直接看 webpack 包（这个 node_modules\webpack 目录下）的 package.json 文件，并找到部分内容：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">"main"</span>: <span class="string">"lib/webpack.js"</span>,</div><div class="line"><span class="string">"web"</span>: <span class="string">"lib/webpack.web.js"</span>,</div><div class="line"><span class="string">"bin"</span>: <span class="string">"./bin/webpack.js"</span>,</div></pre></td></tr></table></figure>
<p>其他我们都不看，直接关注 main 这个属性，这就是我们在 Node 环境中执行 webpack 的入口。那么，我们得到完整的 webpack 代码路径：</p>
<p>node_modules\webpack\lib\webpack.js</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">const webpack = (<span class="keyword">options</span>, callback) =&gt; &#123;</div><div class="line">	...</div><div class="line">	let compiler;</div><div class="line">  <span class="comment">// 根据配置类型是数组还是对象，来创建 compiler 对象</span></div><div class="line">	<span class="keyword">if</span> (Array.isArray(<span class="keyword">options</span>)) &#123;</div><div class="line">		...</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeof <span class="keyword">options</span> === <span class="string">"object"</span>) &#123;</div><div class="line">    <span class="comment">// 一般情况下，module.export 出来就是单个配置。我们可以主要看这里的代码</span></div><div class="line"></div><div class="line">    <span class="comment">// 首先，通过一个默认选项对象 WebpackOptionsDefaulter 对我们的配置项进行处理</span></div><div class="line">		<span class="keyword">options</span> = <span class="keyword">new</span> WebpackOptionsDefaulter().process(<span class="keyword">options</span>);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// 创建 compiler 对象，该对象贯穿webpack的整个生命周期</span></div><div class="line">		compiler = <span class="keyword">new</span> Compiler(<span class="keyword">options</span>.context);</div><div class="line">		compiler.<span class="keyword">options</span> = <span class="keyword">options</span>;</div><div class="line">		<span class="keyword">new</span> NodeEnvironmentPlugin(&#123;</div><div class="line">			infrastructureLogging: <span class="keyword">options</span>.infrastructureLogging</div><div class="line">		&#125;).apply(compiler);</div><div class="line">    <span class="comment">// 重要！！！执行配置项里所有 plugin 对象的 apply 方法，如果是函数则执行该函数</span></div><div class="line">		<span class="keyword">if</span> (<span class="keyword">options</span>.plugins &amp;&amp; Array.isArray(<span class="keyword">options</span>.plugins)) &#123;</div><div class="line">			<span class="keyword">for</span> (const plugin of <span class="keyword">options</span>.plugins) &#123;</div><div class="line">				<span class="keyword">if</span> (typeof plugin === <span class="string">"function"</span>) &#123;</div><div class="line">					plugin.<span class="keyword">call</span>(compiler, compiler);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					plugin.apply(compiler);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// 执行完成环境配置步骤相关的 hooks</span></div><div class="line">		compiler.hooks.environment.<span class="keyword">call</span>();</div><div class="line">		compiler.hooks.afterEnvironment.<span class="keyword">call</span>();</div><div class="line">    </div><div class="line">    <span class="comment">// 重要！！！process 方法将会添加更多的 plugin、初始化 resolver 以及执行 hooks</span></div><div class="line">		compiler.<span class="keyword">options</span> = <span class="keyword">new</span> WebpackOptionsApply().process(<span class="keyword">options</span>, compiler);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (callback) &#123;</div><div class="line">    <span class="keyword">if</span> (</div><div class="line">			<span class="keyword">options</span>.watch === <span class="keyword">true</span> ||</div><div class="line">			(Array.isArray(<span class="keyword">options</span>) &amp;&amp; <span class="keyword">options</span>.some(o =&gt; o.watch))</div><div class="line">		) &#123;</div><div class="line">			const watchOptions = Array.isArray(<span class="keyword">options</span>)</div><div class="line">				? <span class="keyword">options</span>.map(o =&gt; o.watchOptions || &#123;&#125;)</div><div class="line">				: <span class="keyword">options</span>.watchOptions || &#123;&#125;;</div><div class="line">      <span class="comment">// 运行 compiler，这里会开启监听模式，后面会针对这个进行分析，</span></div><div class="line">			<span class="keyword">return</span> compiler.watch(watchOptions, callback);</div><div class="line">		&#125;</div><div class="line">		...</div><div class="line">    <span class="comment">// 运行 comiler，进行编译工作</span></div><div class="line">		compiler.run(callback);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> compiler;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">exports = module.exports = webpack;</div></pre></td></tr></table></figure>
<p>通过以上的代码，主要完成了以下几个工作：</p>
<ul>
<li>1、配置项处理</li>
<li>2、创建 compiler 对象</li>
<li>3、执行配置项里 plugins 的 apply 方法</li>
<li>4、执行环境配置相关的 hooks</li>
<li>5、执行 WebpackOptionsApply 的 process 方法，这个方法的代码我在下面讲解</li>
<li>6、执行 compiler 的 run 或 watch 方法，真正的执行编译的任务</li>
</ul>
<h2 id="2-2、来自-WebpackOptionsApply-process-的加餐"><a href="#2-2、来自-WebpackOptionsApply-process-的加餐" class="headerlink" title="2.2、来自 WebpackOptionsApply.process 的加餐"></a>2.2、来自 WebpackOptionsApply.process 的加餐</h2><p>上一节中提到  WebpackOptionsApply 的 process 方法，这个方法很长，大概4、500行（包括注释部分）。<br>我们会针对这个方法进行重点解释。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line">process(<span class="keyword">options</span>, compiler) &#123;</div><div class="line">	let ExternalsPlugin;</div><div class="line">  <span class="comment">// 上来是一大堆的属性配置，主要是一些输入、输出的路径</span></div><div class="line">	compiler.outputPath = <span class="keyword">options</span>.output.path;</div><div class="line">  ……</div><div class="line">  <span class="comment">// 最终打包出的代码运行的目标环境，做一些插件创建和 apply 方法执行</span></div><div class="line">	<span class="keyword">if</span> (typeof <span class="keyword">options</span>.target === <span class="string">"string"</span>) &#123;</div><div class="line">		let JsonpTemplatePlugin;</div><div class="line">		let FetchCompileWasmTemplatePlugin;</div><div class="line">		……</div><div class="line">		<span class="keyword">switch</span> (<span class="keyword">options</span>.target) &#123;</div><div class="line">			<span class="keyword">case</span> <span class="string">"web"</span>:</div><div class="line">        <span class="comment">// 针对web浏览器目标环境的处理</span></div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			<span class="keyword">case</span> <span class="string">"node"</span>:</div><div class="line">			...</div><div class="line">			<span class="keyword">default</span>:</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Unsupported target '"</span> + <span class="keyword">options</span>.target + <span class="string">"'."</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	……</div><div class="line">  <span class="comment">// 如果是打包成一个库的配置处理</span></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">options</span>.output.library || <span class="keyword">options</span>.output.libraryTarget !== <span class="string">"var"</span>) &#123;</div><div class="line">		const LibraryTemplatePlugin = require(<span class="string">"./LibraryTemplatePlugin"</span>);</div><div class="line">		<span class="keyword">new</span> LibraryTemplatePlugin(</div><div class="line">			<span class="keyword">options</span>.output.library,</div><div class="line">			<span class="keyword">options</span>.output.libraryTarget,</div><div class="line">			……</div><div class="line">		).apply(compiler);</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 对于引入的依赖包在打包中进行去除，希望通过cdn方式或其他方式的处理</span></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">options</span>.externals) &#123;</div><div class="line">		ExternalsPlugin = require(<span class="string">"./ExternalsPlugin"</span>);</div><div class="line">		<span class="keyword">new</span> ExternalsPlugin(</div><div class="line">			<span class="keyword">options</span>.output.libraryTarget,</div><div class="line">			<span class="keyword">options</span>.externals</div><div class="line">		).apply(compiler);</div><div class="line">	&#125;</div><div class="line">  ……</div><div class="line">  <span class="comment">// sourcemap 的处理</span></div><div class="line">	<span class="keyword">if</span> (</div><div class="line">		<span class="keyword">options</span>.devtool &amp;&amp;</div><div class="line">		(<span class="keyword">options</span>.devtool.<span class="keyword">includes</span>(<span class="string">"sourcemap"</span>) ||</div><div class="line">			<span class="keyword">options</span>.devtool.<span class="keyword">includes</span>(<span class="string">"source-map"</span>))</div><div class="line">	) &#123;</div><div class="line">    <span class="comment">// sourcemap 参数处理</span></div><div class="line">		const hidden = <span class="keyword">options</span>.devtool.<span class="keyword">includes</span>(<span class="string">"hidden"</span>);</div><div class="line">		const inline = <span class="keyword">options</span>.devtool.<span class="keyword">includes</span>(<span class="string">"inline"</span>);</div><div class="line">		……</div><div class="line">    <span class="comment">// 插件处理</span></div><div class="line">		const Plugin = evalWrapped</div><div class="line">			? EvalSourceMapDevToolPlugin</div><div class="line">			: SourceMapDevToolPlugin;</div><div class="line">		<span class="keyword">new</span> Plugin(&#123;</div><div class="line">			filename: inline ? <span class="keyword">null</span> : <span class="keyword">options</span>.output.sourceMapFilename,</div><div class="line">			moduleFilenameTemplate: <span class="keyword">options</span>.output.devtoolModuleFilenameTemplate,</div><div class="line">			……</div><div class="line">		&#125;).apply(compiler);</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">options</span>.devtool &amp;&amp; <span class="keyword">options</span>.devtool.<span class="keyword">includes</span>(<span class="string">"eval"</span>)) &#123;</div><div class="line">		……</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// compiler.hooks.entryOption 的执行</span></div><div class="line">	compiler.hooks.entryOption.<span class="keyword">call</span>(<span class="keyword">options</span>.context, <span class="keyword">options</span>.entry);</div><div class="line">	</div><div class="line">  <span class="comment">// 严格模式的插件，这个我们在下面可以看一下它的源码部分</span></div><div class="line">	<span class="keyword">new</span> UseStrictPlugin().apply(compiler);</div><div class="line">  ……</div><div class="line">	<span class="comment">// 在 optimization 中开启 sideEffects 的处理</span></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">options</span>.optimization.sideEffects) &#123;</div><div class="line">		const SideEffectsFlagPlugin = require(<span class="string">"./optimize/SideEffectsFlagPlugin"</span>);</div><div class="line">		<span class="keyword">new</span> SideEffectsFlagPlugin().apply(compiler);</div><div class="line">	&#125;</div><div class="line">  ……</div><div class="line">	<span class="comment">// 代码做 split</span></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">options</span>.optimization.splitChunks) &#123;</div><div class="line">		const SplitChunksPlugin = require(<span class="string">"./optimize/SplitChunksPlugin"</span>);</div><div class="line">		<span class="keyword">new</span> SplitChunksPlugin(<span class="keyword">options</span>.optimization.splitChunks).apply(compiler);</div><div class="line">	&#125;</div><div class="line">	……<span class="comment">// 省略的这部分都和 module 和 chunk 相关</span></div><div class="line">  <span class="comment">// 压缩配置</span></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">options</span>.optimization.minimize) &#123;</div><div class="line">		<span class="keyword">for</span> (const minimizer of <span class="keyword">options</span>.optimization.minimizer) &#123;</div><div class="line">			<span class="keyword">if</span> (typeof minimizer === <span class="string">"function"</span>) &#123;</div><div class="line">				minimizer.<span class="keyword">call</span>(compiler, compiler);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				minimizer.apply(compiler);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">options</span>.performance) &#123;</div><div class="line">		const SizeLimitsPlugin = require(<span class="string">"./performance/SizeLimitsPlugin"</span>);</div><div class="line">		<span class="keyword">new</span> SizeLimitsPlugin(<span class="keyword">options</span>.performance).apply(compiler);</div><div class="line">	&#125;</div><div class="line">	……</div><div class="line">  <span class="comment">// compiler.hooks.afterPlugins 调用</span></div><div class="line">	compiler.hooks.afterPlugins.<span class="keyword">call</span>(compiler);</div><div class="line">	<span class="keyword">if</span> (!compiler.inputFileSystem) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"No input filesystem provided"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// compiler.resolverFactory.hooks 上挂一些钩子</span></div><div class="line">	compiler.resolverFactory.hooks.resolveOptions</div><div class="line">		.<span class="keyword">for</span>(<span class="string">"normal"</span>)</div><div class="line">		.tap(<span class="string">"WebpackOptionsApply"</span>, resolveOptions =&gt; &#123;</div><div class="line">			<span class="keyword">return</span> Object.assign(</div><div class="line">				&#123;</div><div class="line">					fileSystem: compiler.inputFileSystem</div><div class="line">				&#125;,</div><div class="line">				cachedCleverMerge(<span class="keyword">options</span>.resolve, resolveOptions)</div><div class="line">			);</div><div class="line">		&#125;);</div><div class="line">	……</div><div class="line">  <span class="comment">// compiler.hooks.afterResolvers 调用</span></div><div class="line">	compiler.hooks.afterResolvers.<span class="keyword">call</span>(compiler);</div><div class="line">	<span class="keyword">return</span> <span class="keyword">options</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ok，可以看到在进入到 compiler.run 之前，在这里又做了大量的工作。这里主要的工作集中在根据我们对于 webpack 的配置项进行插件的添加和 apply 方法的执行。我们在上面的代码讲解里有一个严格模式的插件，我们简单看下它的源码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">apply(compiler) &#123;</div><div class="line">	compiler.hooks.compilation.tap(</div><div class="line">		<span class="string">"UseStrictPlugin"</span>,</div><div class="line">		<span class="function">(<span class="params">compilation, &#123; normalModuleFactory &#125;</span>) =&gt;</span> &#123;</div><div class="line">			<span class="keyword">const</span> handler = <span class="function"><span class="params">parser</span> =&gt;</span> &#123;</div><div class="line">				parser.hooks.program.tap(<span class="string">"UseStrictPlugin"</span>, <span class="function"><span class="params">ast</span> =&gt;</span> &#123;</div><div class="line">					<span class="keyword">const</span> firstNode = ast.body[<span class="number">0</span>];</div><div class="line">					……<span class="comment">// 一些处理代码 </span></div><div class="line">				&#125;);</div><div class="line">			&#125;;</div><div class="line">			normalModuleFactory.hooks.parser</div><div class="line">				.for(<span class="string">"javascript/auto"</span>)</div><div class="line">				.tap(<span class="string">"UseStrictPlugin"</span>, handler);</div><div class="line">			……</div><div class="line">		&#125;</div><div class="line">	);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里它主要通过钩子方法，可以在对代码生成一颗抽象语法树 ast 之后，拿到 ast，并做一些工作。这个地方其实给了我们一些启示，能够针对 ast 进行一些操作，当然还可以使用 Babel 作为可选方案。</p>
<h2 id="2-3、贯穿始终的-Compiler"><a href="#2-3、贯穿始终的-Compiler" class="headerlink" title="2.3、贯穿始终的 Compiler"></a>2.3、贯穿始终的 Compiler</h2><p>Compiler 和 Compilation 是两个在 webpack 的 plugin 中常用的两个对象。二者也包含了很多的 hooks，这些 hooks 代表了 webpack 在执行过程的不同阶段。其中，通过前面的代码我们看到了 Compiler 的创建过程，它包含了很多的配置项 options，里面又包含了 Loader 和 Plugin 信息。其生命周期一直到 webpack 结束，几乎等同于 webpack 实例本身。</p>
<p>而 Compilation 到此为止，我们还没有看到。它其实只是一次编程过程，包含了 Module、编译后的输出等，同时他也拥有 Compiler 对象实例。</p>
<p>在上面对于 webpack 执行入口的源码分析中，我们看到了 compiler.watch 或 compiler.run 才真正执行起来。我们一般在开发阶段中会使用到 webpack-dev-server ，它这里 Watch 模式默认开启。本文要讲以 compiler.watch 方法作为入口继续源码的分析。</p>
<p><strong>源码位置 node_modules\webpack\lib\Compiler.js</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">watch(watchOptions, handler) &#123;</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.running) <span class="keyword">return</span> handler(new ConcurrentCompilationError());</div><div class="line">	<span class="keyword">this</span>.running = <span class="literal">true</span>;</div><div class="line">	<span class="keyword">this</span>.watchMode = <span class="literal">true</span>;</div><div class="line">	……</div><div class="line">	<span class="keyword">return</span> new Watching(<span class="keyword">this</span>, watchOptions, handler);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>前面的一些设置代码，我们可以忽略，直接看最后创建并返回了一个 Watching 对象。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watching</span> </span>&#123;</div><div class="line">	<span class="keyword">constructor</span>(compiler, watchOptions, handler) &#123;</div><div class="line">		……</div><div class="line">		<span class="keyword">this</span>.compiler = compiler;</div><div class="line">		<span class="keyword">this</span>.running = <span class="literal">true</span>;</div><div class="line">    <span class="comment">// 这里调用了 compiler.readRecords 方法，该方法比较简单，最后会执行回调方法</span></div><div class="line">		<span class="keyword">this</span>.compiler.readRecords(err =&gt; &#123;</div><div class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="keyword">this</span>._done(err);</div><div class="line">      <span class="comment">// 最后还是来到 _go 方法</span></div><div class="line">			<span class="keyword">this</span>._go();</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	_go() &#123;</div><div class="line">		……</div><div class="line">    <span class="comment">// 执行 compiler.hooks.watchRun</span></div><div class="line">		<span class="keyword">this</span>.compiler.hooks.watchRun.callAsync(<span class="keyword">this</span>.compiler, err =&gt; &#123;</div><div class="line">			const onCompiled = (err, compilation) =&gt; &#123;</div><div class="line">        <span class="comment">// 实际上最终执行的是 compiler.hooks.emit</span></div><div class="line">				<span class="keyword">this</span>.compiler.emitAssets(compilation, err =&gt; &#123;</div><div class="line">					<span class="comment">// </span></div><div class="line">					<span class="keyword">this</span>.compiler.emitRecords(err =&gt; &#123;</div><div class="line">						……</div><div class="line">            <span class="comment">// 执行</span></div><div class="line">						<span class="keyword">return</span> <span class="keyword">this</span>._done(<span class="literal">null</span>, compilation);</div><div class="line">					&#125;);</div><div class="line">				&#125;);</div><div class="line">			&#125;;</div><div class="line">      <span class="comment">// 在执行 compiler.hooks.watchRun 后，真正进入编译阶段，并传入 onCompiled 这个回调函数</span></div><div class="line">			<span class="keyword">this</span>.compiler.compile(onCompiled);</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  _done(err, compilation) &#123;</div><div class="line">		<span class="keyword">this</span>.running = <span class="literal">false</span>;</div><div class="line">		<span class="keyword">if</span> (err) &#123;</div><div class="line">      <span class="comment">// 出错之后，执行 compiler.hooks.failed</span></div><div class="line">			<span class="keyword">this</span>.compiler.hooks.failed.call(err);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// 编译正常完成，执行 compiler.hooks.done</span></div><div class="line">		<span class="keyword">this</span>.compiler.hooks.done.callAsync(stats, () =&gt; &#123;</div><div class="line">			<span class="keyword">if</span> (!<span class="keyword">this</span>.closed) &#123;</div><div class="line">        <span class="comment">// 监听，暂时略过</span></div><div class="line">				<span class="keyword">this</span>.watch(</div><div class="line">				……</div><div class="line">				);</div><div class="line">			&#125;</div><div class="line">			……</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ok，到这里可能有点混乱了，我们来理一理流程主线：</p>
<p><strong>Compiler.watch() —-&gt;&gt; Watching._go() —-&gt;&gt; Compiler.hooks.watchRun —-&gt;&gt; <em>Compiler.compile(onCompiled)</em> —-&gt;&gt; onCompiled —-&gt;&gt; 执行 Compiler.hooks.emit 和 Watching._done() —-&gt;&gt; Compiler.hooks.done (通过Watching._done)</strong>。</p>
<p>这个主线里，我们重点要记住 Compiler.hooks.emit 和 Compiler.hooks.done。前者是即将进行 output，这是我们最后能够修改模块内容的机会，后者则是完成编译文件输出。另外，在这个主线里，我们看到缺了 Compiler.compile(onCompiled) 这一部分的内容。接下来，我们继续 Compiler 的源码部分</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">node_modules\webpack\lib\Compiler.js</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compiler</span> <span class="title">extends</span> <span class="title">Tapable</span> </span>&#123;</div><div class="line">	createCompilation() &#123;</div><div class="line">		<span class="keyword">return</span> new Compilation(<span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	newCompilation(params) &#123;</div><div class="line">		const compilation = <span class="keyword">this</span>.createCompilation();</div><div class="line">		……</div><div class="line">    <span class="comment">// 执行两个 hooks，至此，compilation 才真正被创建</span></div><div class="line">		<span class="keyword">this</span>.hooks.thisCompilation.call(compilation, params);</div><div class="line">		<span class="keyword">this</span>.hooks.compilation.call(compilation, params);</div><div class="line">		<span class="keyword">return</span> compilation;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	createNormalModuleFactory() &#123;</div><div class="line">		const normalModuleFactory = new NormalModuleFactory(……);</div><div class="line">    <span class="comment">// 调用 hooks.normalModuleFactory</span></div><div class="line">		<span class="keyword">this</span>.hooks.normalModuleFactory.call(normalModuleFactory);</div><div class="line">		<span class="keyword">return</span> normalModuleFactory;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	createContextModuleFactory() &#123;</div><div class="line">		const contextModuleFactory = new ContextModuleFactory(<span class="keyword">this</span>.resolverFactory);</div><div class="line">    <span class="comment">// 调用 hooks.contextModuleFactory</span></div><div class="line">		<span class="keyword">this</span>.hooks.contextModuleFactory.call(contextModuleFactory);</div><div class="line">		<span class="keyword">return</span> contextModuleFactory;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	newCompilationParams() &#123;</div><div class="line">    <span class="comment">// 主要是创建两个工厂实例</span></div><div class="line">		const params = &#123;</div><div class="line">			normalModuleFactory: <span class="keyword">this</span>.createNormalModuleFactory(),</div><div class="line">			contextModuleFactory: <span class="keyword">this</span>.createContextModuleFactory(),</div><div class="line">			compilationDependencies: new Set()</div><div class="line">		&#125;;</div><div class="line">		<span class="keyword">return</span> params;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	compile(callback) &#123;</div><div class="line">    <span class="comment">// 拿到创建 Compilation 的参数</span></div><div class="line">		const params = <span class="keyword">this</span>.newCompilationParams();</div><div class="line">    <span class="comment">// 执行 hooks.beforeCompile</span></div><div class="line">		<span class="keyword">this</span>.hooks.beforeCompile.callAsync(params, err =&gt; &#123;</div><div class="line">      <span class="comment">// 执行 hooks.compile，到这里为止，compilation 还未创建</span></div><div class="line">			<span class="keyword">this</span>.hooks.compile.call(params);</div><div class="line"></div><div class="line">      <span class="comment">// 创建 Compilation 对象</span></div><div class="line">			const compilation = <span class="keyword">this</span>.newCompilation(params);</div><div class="line">      <span class="comment">// hooks.make 进入编译阶段</span></div><div class="line">			<span class="keyword">this</span>.hooks.make.callAsync(compilation, err =&gt; &#123;</div><div class="line">        <span class="comment">// compilation 部分</span></div><div class="line">				compilation.finish(err =&gt; &#123;</div><div class="line">					compilation.seal(err =&gt; &#123;</div><div class="line">            <span class="comment">// 执行 hooks.afterCompile，这里已经完成编译的部分</span></div><div class="line">						<span class="keyword">this</span>.hooks.afterCompile.callAsync(compilation, err =&gt; &#123;</div><div class="line">              <span class="comment">// 这里就是那个 onCompiled 回调最终被执行</span></div><div class="line">							<span class="keyword">return</span> callback(<span class="literal">null</span>, compilation);</div><div class="line">						&#125;);</div><div class="line">					&#125;);</div><div class="line">				&#125;);</div><div class="line">			&#125;);</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成了上述代码的过程，我们对上面的 compiler.compile() 内部的流程主线可以归纳（侧重 hooks 部分）：<br><strong>compiler.compile() —-&gt;&gt; compiler.hooks.normalModuleFactory 和 compiler.hooks.contextModuleFactory —-&gt;&gt; compiler.hooks.beforeCompile —-&gt;&gt; compiler.hooks.compile —-&gt;&gt; compiler.hooks.thisCompilation —-&gt;&gt; compiler.hooks.compilation —-&gt;&gt; compiler.hooks.make —-&gt;&gt; <em>compilation.finish() —-&gt;&gt; compilation.seal()</em> —-&gt;&gt; compiler.hooks.afterCompile —-&gt;&gt; onCompiled()</strong></p>
<p>hooks 本质上反映的是整个 webpack 运行的不同阶段。在上面这个主线中，我们其实重点关注两个点：</p>
<ul>
<li>compiler.hooks.make，从这里开始正式进入编译<!-- - compilation.finish() 函数，它的执行标识着编译完成 --></li>
<li>compilation.seal() 函数，它的执行标识着封闭编译，不再添加 module</li>
</ul>
<p>然后我们看到从 compiler.hooks.make 直接到了 compilation.finish() 这一步。中间经历了什么，我们在下一节中进行源码分析。</p>
<blockquote>
<p>另外，上述代码中生成了两个工厂对象：<em>ContextModuleFactory 和 NormalModuleFactory</em> 。其中，ContextModuleFactory 用来解析目录，为每个文件生成请求，并依据传递来的 regExp 进行过滤。最后匹配成功的依赖关系将被传入 NormalModuleFactory 。NormalModuleFactory 用来生成各类模块。从入口点开始，它会分解每个请求，解析文件内容以查找进一步的请求，然后通过分解所有请求以及解析新的文件来爬取全部文件。在最后阶段，每个依赖项都会成为一个模块实例。</p>
</blockquote>
<h2 id="2-4、大包干的-Compilation"><a href="#2-4、大包干的-Compilation" class="headerlink" title="2.4、大包干的 Compilation"></a>2.4、大包干的 Compilation</h2><p>在上一节的最后，我们缺了一大块内部，就是怎么就从 compiler.hooks.make 直接到了 compilation.finish() 这一步？开发过 plugin 的同学应该知道，通过 hooks 我们可以通过 tap 方法去钩住某个执行阶段，compiler.hooks.make 执行就会触发这些 hooks。我们通过调试或在 ./node_modules/webpack 下用关键词搜索 hooks.make.tap 可以发现很多插件。比如：DllEntryPlugin、MultiEntryPlugin、AutomaticPrefetchPlugin、PrefetchPlugin等，我们以 MultiEntryPlugin 为例来看一下它的源码实现：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">node_modules\webpack\lib\MultiEntryPlugin.js</div><div class="line"></div><div class="line"><span class="keyword">class</span> MultiEntryPlugin &#123;</div><div class="line">	apply(compiler) &#123;</div><div class="line">		compiler.hooks.make.tapAsync(</div><div class="line">			<span class="string">"MultiEntryPlugin"</span>,</div><div class="line">			<span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</div><div class="line">				<span class="keyword">const</span> &#123; context, entries, name &#125; = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 生成一个 MultiEntryDependency 依赖对象</span></div><div class="line">				<span class="keyword">const</span> dep = MultiEntryPlugin.createDependency(entries, name);</div><div class="line">        <span class="comment">// 调用了 compilation.addEntry 方法</span></div><div class="line">				compilation.addEntry(context, dep, name, callback);</div><div class="line">			&#125;</div><div class="line">		);</div><div class="line">	&#125;</div><div class="line">  <span class="keyword">static</span> createDependency(entries, name) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> MultiEntryDependency(</div><div class="line">			entries.map(<span class="function">(<span class="params">e, idx</span>) =&gt;</span> &#123;</div><div class="line">				<span class="keyword">const</span> dep = <span class="keyword">new</span> SingleEntryDependency(e);</div><div class="line">				<span class="keyword">return</span> dep;</div><div class="line">			&#125;),</div><div class="line">			name</div><div class="line">		);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过插件在 compiler.hooks.make 上挂的钩子，成功的从 compiler 转译到了 compilation 的执行阶段。 compilation.addEntry(context, dep, name, callback) 方法从名字上，我们就可以看出是为编译添加入口，其实这并不难理解。接下来，我们看看 addEntry 方法之后都干了些什么：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line">node_modules\webpack\lib\Compilation.js</div><div class="line"></div><div class="line">addEntry(context, entry, name, callback) &#123;</div><div class="line">	<span class="keyword">this</span>.hooks.addEntry.call(entry, name);</div><div class="line"></div><div class="line">  <span class="comment">// 添加模块链接，其实就是从 entry 入口开始对每个模块 build，然后分析出依赖模型进行 build 的一个过程</span></div><div class="line">	<span class="keyword">this</span>._addModuleChain(</div><div class="line">		context,</div><div class="line">		entry,</div><div class="line">		<span class="built_in">module</span> =&gt; &#123;</div><div class="line">			<span class="keyword">this</span>.entries.push(<span class="built_in">module</span>);</div><div class="line">		&#125;,</div><div class="line">		(err, <span class="built_in">module</span>) =&gt; &#123;</div><div class="line">			<span class="comment">// </span></div><div class="line">			<span class="keyword">this</span>.hooks.succeedEntry.call(entry, name, <span class="built_in">module</span>);</div><div class="line">			<span class="keyword">return</span> callback(<span class="literal">null</span>, <span class="built_in">module</span>);</div><div class="line">		&#125;</div><div class="line">	);</div><div class="line">&#125;</div><div class="line"></div><div class="line">_addModuleChain(context, dependency, onModule, callback) &#123;</div><div class="line">	<span class="keyword">const</span> Dep = <span class="comment">/** @type &#123;DepConstructor&#125; */</span> (dependency.constructor);</div><div class="line">  <span class="comment">// dependencyFactories 里有很多类型的工厂对象，通过依赖的具体类型拿到工厂对象，暂时忽略下</span></div><div class="line">	<span class="keyword">const</span> moduleFactory = <span class="keyword">this</span>.dependencyFactories.get(Dep);</div><div class="line">	</div><div class="line">	<span class="keyword">this</span>.semaphore.acquire(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="comment">// 通过模块工厂对象创建模块，工厂的 create 方法，我们先放一下，在后面说。</span></div><div class="line">		moduleFactory.create(&#123;&#125;,</div><div class="line">			(err, <span class="built_in">module</span>) =&gt; &#123;</div><div class="line">				<span class="comment">// 添加模块</span></div><div class="line">				<span class="keyword">const</span> addModuleResult = <span class="keyword">this</span>.addModule(<span class="built_in">module</span>);</div><div class="line">				</div><div class="line">				<span class="keyword">const</span> afterBuild = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">					<span class="keyword">if</span> (addModuleResult.dependencies) &#123;</div><div class="line">            <span class="comment">// 处理依赖模块</span></div><div class="line">						<span class="keyword">this</span>.processModuleDependencies(<span class="built_in">module</span>, err =&gt; &#123;&#125;);</div><div class="line">					&#125;</div><div class="line">				&#125;;</div><div class="line">				</div><div class="line">				<span class="keyword">if</span> (addModuleResult.build) &#123;</div><div class="line">          <span class="comment">// 开始构建模块</span></div><div class="line">					<span class="keyword">this</span>.buildModule(<span class="built_in">module</span>, <span class="literal">false</span>, <span class="literal">null</span>, <span class="literal">null</span>, err =&gt; &#123;</div><div class="line">            <span class="comment">// 完成构建之后，继续后面有可能的依赖模块处理</span></div><div class="line">						afterBuild();</div><div class="line">					&#125;);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		);</div><div class="line">	&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">addModule(<span class="built_in">module</span>, cacheGroup) &#123;</div><div class="line">  <span class="comment">// 缓存，这里根据模块的标识符进行查找</span></div><div class="line">	<span class="keyword">const</span> identifier = <span class="built_in">module</span>.identifier();</div><div class="line">  <span class="comment">// _modules 里存放的是已经添加的模块信息</span></div><div class="line">	<span class="keyword">const</span> alreadyAddedModule = <span class="keyword">this</span>._modules.get(identifier);</div><div class="line">	<span class="keyword">if</span> (alreadyAddedModule) &#123;</div><div class="line">		<span class="keyword">return</span> &#123;</div><div class="line">			<span class="attr">module</span>: alreadyAddedModule,</div><div class="line">			<span class="attr">issuer</span>: <span class="literal">false</span>,</div><div class="line">			<span class="attr">build</span>: <span class="literal">false</span>,</div><div class="line">			<span class="attr">dependencies</span>: <span class="literal">false</span></div><div class="line">		&#125;;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">const</span> cacheName = (cacheGroup || <span class="string">"m"</span>) + identifier;</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.cache &amp;&amp; <span class="keyword">this</span>.cache[cacheName]) &#123;</div><div class="line">		<span class="comment">// 这里面主要是针对缓存部分有更新的处理，需要对模块进行 reBuild 处理</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attr">module</span>: <span class="built_in">module</span>,</div><div class="line">		<span class="attr">issuer</span>: <span class="literal">true</span>,</div><div class="line">		<span class="attr">build</span>: <span class="literal">true</span>,</div><div class="line">		<span class="attr">dependencies</span>: <span class="literal">true</span></div><div class="line">	&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">buildModule(<span class="built_in">module</span>, optional, origin, dependencies, thisCallback) &#123;</div><div class="line">	<span class="comment">// 在模块构建开始之前触发，可以用来修改模块。</span></div><div class="line">	<span class="keyword">this</span>.hooks.buildModule.call(<span class="built_in">module</span>);</div><div class="line"></div><div class="line">  <span class="comment">// 使用模块对象进行构建</span></div><div class="line">	<span class="built_in">module</span>.build(</div><div class="line">		<span class="keyword">this</span>.options,</div><div class="line">		<span class="keyword">this</span>,</div><div class="line">		<span class="keyword">this</span>.resolverFactory.get(<span class="string">"normal"</span>, <span class="built_in">module</span>.resolveOptions),</div><div class="line">		<span class="keyword">this</span>.inputFileSystem,</div><div class="line">		error =&gt; &#123;</div><div class="line">			<span class="comment">// 执行成功构建的钩子</span></div><div class="line">			<span class="keyword">this</span>.hooks.succeedModule.call(<span class="built_in">module</span>);</div><div class="line">			<span class="keyword">return</span> callback();</div><div class="line">		&#125;</div><div class="line">	);</div><div class="line">&#125;</div><div class="line"></div><div class="line">processModuleDependencies(<span class="built_in">module</span>, callback) &#123;</div><div class="line">	<span class="keyword">this</span>.addModuleDependencies(</div><div class="line">		<span class="built_in">module</span>,</div><div class="line">		sortedDependencies,</div><div class="line">		<span class="keyword">this</span>.bail,</div><div class="line">		<span class="literal">null</span>,</div><div class="line">		<span class="literal">true</span>,</div><div class="line">		callback</div><div class="line">	);</div><div class="line">&#125;</div><div class="line"></div><div class="line">addModuleDependencies(</div><div class="line">	<span class="built_in">module</span>,</div><div class="line">	dependencies,</div><div class="line">	bail,</div><div class="line">	cacheGroup,</div><div class="line">	recursive,</div><div class="line">	callback</div><div class="line">) &#123;</div><div class="line">	asyncLib.forEach(</div><div class="line">		dependencies,</div><div class="line">		(item, callback) =&gt; &#123;</div><div class="line">			semaphore.acquire(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">				<span class="keyword">const</span> factory = item.factory;</div><div class="line">				factory.create(&#123;&#125;,</div><div class="line">					(err, dependentModule) =&gt; &#123;</div><div class="line">						<span class="keyword">const</span> addModuleResult = <span class="keyword">this</span>.addModule();</div><div class="line">						<span class="keyword">const</span> afterBuild = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">							<span class="keyword">if</span> (recursive &amp;&amp; addModuleResult.dependencies) &#123;</div><div class="line">								<span class="keyword">this</span>.processModuleDependencies(dependentModule, callback);</div><div class="line">							&#125;</div><div class="line">						&#125;;</div><div class="line">						</div><div class="line">						<span class="keyword">if</span> (addModuleResult.build) &#123;</div><div class="line">							<span class="keyword">this</span>.buildModule(</div><div class="line">								<span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">									afterBuild();</div><div class="line">								&#125;</div><div class="line">							);</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">				);</div><div class="line">			&#125;);</div><div class="line">		&#125;,</div><div class="line">		err =&gt; &#123;</div><div class="line">		&#125;</div><div class="line">	);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这一块涉及到 compilation 中的几个方法，源码部分很多，笔者删除了大部分。主线捋一捋大致如下：通过 addEntry 找到入口模块然后把模块和依赖模块进行构建，构建过程是先构建当前模块，该过程伴随着缓存的处理和更新，真正的构建是通过具体模块对象的 module.build 方法进行（这个后面系列的文章中分析）。构建完当前模块后对分析出来的依赖模型就行构建，不断重复该过程直至所有的模块构建完毕。在这个过程中伴随着一些 hooks 的执行。</p>
<p>那么回到之前的那个问题，现在我们知道了如何从 compiler.hooks.make 顺滑的走到了 compilation.addEntry ，最终完成模块的构建工作。单个模块完成构建工作后执行了 compilation.hooks.succeedModule 钩子。那么，webpack 如何确定所有的模块以及构建完成最终执行了 compilation.finish() 呢？这个问题，我们放到下一篇文章中去介绍 Tapable 和 Hook。另外，我们在上面的源码分析中留下了一个问题就是模块如何构建，这个在系列三中去解答。</p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Web/" rel="tag">#Web</a>
          
            <a href="/tags/工程化/" rel="tag">#工程化</a>
          
            <a href="/tags/Webpack/" rel="tag">#Webpack</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/10/24/再读 Webpack 源码，各个击破（二）：深入 Tapable 及 hooks/" rel="prev">再读 Webpack 源码，各个击破（二）：深入 Tapable 及 Hook</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/10/11/Promise 学习系列：下篇/" rel="next">Promise 学习系列：下篇</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div>
      
        <style type="text/css">

    .donate_bar {
        text-align: center;
        margin-top : 5%;
    }

    .donate_bar.hidden {
        display:none;
    }
/*
    .donate_bar a.btn_donate {
        display: inline-block;
        width: 82px;
        height: 82px;
        margin-left:auto;
        margin-right:auto;

        background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
        _background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat; 

        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
    }
*/
    .donate_bar a.btn_donate:hover { 
        // background-position: 0px -82px;
        color: #87daff
    }

    .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
    }

    .bold { 
        font-weight: bold; 
    }

    .post-donate a {
        border-bottom: 0px;
    }

    #donate_guide table {
        border: none;
    }

    #donate_guide td {
        border-bottom: none;
        border-right: none;
        background: #333333;
        valign: top;
    }

</style>



    

    <div class ="post-donate">
        <div id="donate_board" class="donate_bar center">
              <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏">赏</a>
              <span id="donate_txt" class="donate_txt">
                   
                        请我喝杯茶
                   
              </span>
            <br>
        </div>  
  
        <div id="donate_guide" class="donate_bar center hidden">
            <!--
            
                <a href="http://ofdub8np7.bkt.clouddn.com/pay/alipay.png" title="支付宝打赏" class="fancybox" rel="article0" 
                    style="float:left;margin-left:25%;margin-right:10px;">
                    <img src="http://ofdub8np7.bkt.clouddn.com/pay/alipay.png" title="" height="164px" width="164px">
                </a> 
              

            
                <a href="http://ofdub8np7.bkt.clouddn.com/pay/wechat.png" title="微信打赏" class="fancybox" rel="article0"
                    style="margin-right:30%">
                    <img src="http://ofdub8np7.bkt.clouddn.com/pay/wechat.png" title="" height="164px" width="164px">
                </a>
            
            -->
            <table>
                <tr>
                    <td>
                        
                            <a href="http://ofdub8np7.bkt.clouddn.com/pay/alipay.png" title="支付宝打赏" class="fancybox" rel="article0" 
                                style="float:left;margin-left:25%;margin-right:10px;">
                                <img src="http://ofdub8np7.bkt.clouddn.com/pay/alipay.png" title="" height="164px" width="164px">
                            </a> 
                         
                    </td>
                    <td>
                        
                            <a href="http://ofdub8np7.bkt.clouddn.com/pay/wechat.png" title="微信打赏" class="fancybox" rel="article0"
                                style="margin-right:30%">
                                <img src="http://ofdub8np7.bkt.clouddn.com/pay/wechat.png" title="" height="164px" width="164px">
                            </a>
                        
                    </td>
                </tr>
            </table>

        </div>

        <script type="text/javascript">
            document.getElementById('btn_donate').onclick = function() {
                $('#donate_board').addClass('hidden');
                // $('#donate_guide').removeClass('hidden');
                $('#donate_guide').show(2000);
            }

        </script>
    </div>

    


      
    </div>

    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
              <div class="ds-thread" data-thread-key="2021/10/18/再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起/"
                   data-title="再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起" data-url="http://whtacm.cc/2021/10/18/再读 Webpack 源码，各个击破（一）：从 Compiler 和 Compilation 说起/">
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Robin" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Robin</p>
        </div>
        <p class="site-description motion-element" itemprop="description">醉卧塌上看风轻云淡，漫卷诗书听雨打芭蕉</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">20</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">26</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="menu-item-icon icon-next-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/whtacm" target="_blank">GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="whtacm@gmail.com" target="_blank">Gmail</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="364432355" target="_blank">QQ</a>
              </span>
            
          
        </div>

        <div class="links-of-friendly motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
              <a href="https://hexo.io/" target="_blank">Hexo</a>
              </span>
            
              <span class="links-of-author-item">
              <a href="http://theme-next.iissnan.com/getting-started.html" target="_blank">NexT</a>
              </span>
            
          
        </div>

        
        

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1、准备工作"><span class="nav-number">1.</span> <span class="nav-text">1、准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1、工具及版本说明"><span class="nav-number">1.1.</span> <span class="nav-text">1.1、工具及版本说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2、约定及说明"><span class="nav-number">1.2.</span> <span class="nav-text">1.2、约定及说明</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2、源码分析"><span class="nav-number">2.</span> <span class="nav-text">2、源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1、Webpack-执行入口"><span class="nav-number">2.1.</span> <span class="nav-text">2.1、Webpack 执行入口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2、来自-WebpackOptionsApply-process-的加餐"><span class="nav-number">2.2.</span> <span class="nav-text">2.2、来自 WebpackOptionsApply.process 的加餐</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3、贯穿始终的-Compiler"><span class="nav-number">2.3.</span> <span class="nav-text">2.3、贯穿始终的 Compiler</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4、大包干的-Compilation"><span class="nav-number">2.4.</span> <span class="nav-text">2.4、大包干的 Compilation</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp;  2016 - 
  <span itemprop="copyrightYear">2021
  </span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Robin
  </span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme by <a class="theme-link" href="http://whtacm.cc">Robin</a>.<a class="theme-link" href="https://github.com/whtacm/hexo-theme-next/tree/magiclamp">Mala</a>
</div>

<!-- busuanzi -->

  <div class="busuanzi-info">
    <div class="theme-info">
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>
    <span id="busuanzi_container_site_pv">
        本站总访问量<a class="theme-link"><span id="busuanzi_value_site_pv"></span></a>次
    </span>
</div>
  </div>



 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"whtacm"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    

    
  
  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/lib/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
